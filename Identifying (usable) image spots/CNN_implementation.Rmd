---
title: "ST_pipeline"
output: html_document
---
Data: https://support.10xgenomics.com/spatial-gene-expression/datasets/1.0.0/V1_Breast_Cancer_Block_A_Section_1?
File contents help: https://support.10xgenomics.com/spatial-gene-expression/software/pipelines/latest/output/images
NN tutorial: https://blog.rstudio.com/2017/09/05/keras-for-r/


You MUST first unpack the gz files!!
```{r setup, include=FALSE}
#devtools::install_github("satijalab/seurat", ref = "spatial")
library(backports)
library(Seurat)
#library(SeuratData)
library(ggplot2)
library(patchwork)
library(dplyr)


library(Matrix)
library(rjson)
library(cowplot)
library(RColorBrewer)
library(grid)
library(readbitmap)
library(hdf5r)
library(data.table)

# Uninstall seurat
# install backports
# put backports on the R library
# devtools::install_github("satijalab/seurat", ref = "spatial") should work now

# must download file from https://www.xquartz.org/
#library(imager)

library(raster)
```

Load in spot position csv
```{r}
# Load in spot location CSV file(doesn't have headers)
image_location <- read.csv("data/spatial/tissue_positions_list.csv", header=FALSE)
names(image_location) <- c("barcode", "in_tissue", "array_row", "array_col", "pxl_col_in_fullres_yValue", "pxl_row_in_fullres_xValue")
```
 
trying to produce image
```{r}
file_name <- 'data/V1_Breast_Cancer_Block_A_Section_1_image.tif'

#creates a raster object from the tiff image file
#imported_raster <- raster(str_name)
wsi <- brick(file_name)

#check to see the image contains the correct amount of pixels
dim(wsi)
plotRGB(wsi)

e <- extent(13091, 13341, 4639, 4889)
cropped_img <- crop(wsi, e)
plotRGB(cropped_img)

# grabbing only the spots with tissue
image_location <- image_location %>%
  filter(in_tissue == 1)

#defining a function to get a cropped spot image given the x and y coordinates of the center of the spot
crop_spot <- function(img, x, y){
e <- extent(x - 136, #using 136 since it is ~half the average distance (273 pixels) between spot centers. We could consider using a different measure to more closely fit to the spot ratius.
              x + 136,
              y - 136,
              y + 136)
cropped_img <- crop(img, e)
return(cropped_img)
}

for (i in 1:length(image_location$in_tissue))
{
  cropped_img <- crop_spot(wsi, 
                           image_location$pxl_row_in_fullres_xValue[i], 
                           image_location$pxl_col_in_fullres_yValue[i])
  plotRGB(cropped_img)
}
```



Testing a NN using kerasR
```{r}
library(kerasR)
library(reticulate)
library(keras)
library(tensorflow)


mnist <- dataset_mnist()
x_train <- mnist$train$x
y_train <- mnist$train$y
x_test <- mnist$test$x
y_test <- mnist$test$y

# reshape
dim(x_train) <- c(nrow(x_train), 784)
dim(x_test) <- c(nrow(x_test), 784)
# rescale
x_train <- x_train / 255
x_test <- x_test / 255

y_train <- to_categorical(y_train, 10)
y_test <- to_categorical(y_test, 10)
```

```{r}
model <- keras_model_sequential() 
model %>% 
  layer_dense(units = 256, activation = "relu", input_shape = c(784)) %>% 
  layer_dropout(rate = 0.4) %>% 
  layer_dense(units = 128, activation = "relu") %>%
  layer_dropout(rate = 0.3) %>%
  layer_dense(units = 10, activation = "softmax")
summary(model)


model %>% compile(
  loss = "categorical_crossentropy",
  optimizer = optimizer_rmsprop(),
  metrics = c("accuracy")
)
```

```{r}
history <- model %>% fit(
  x_train, y_train, 
  epochs = 30, batch_size = 128, 
  validation_split = 0.2
)

plot(history)
```


```{r}
model %>% evaluate(x_test, y_test,verbose = 0)

model %>% predict_classes(x_test)
```


^^^ The lines above are using the MNIST dataset to test NN's on non ST image data ^^^



Testing a CNN found here: 

```{r}

```








Messing around to learn about indexing from raster images and learned the average pixel distance between spot centers
```{r}
#selecting specific rows from the (red) raster image
cropped_img$V1_Breast_Cancer_Block_A_Section_1_image.1[50:100,50:100] <- vector(mode="integer", length=length(cropped_img$V1_Breast_Cancer_Block_A_Section_1_image.1[50:100,50:100]))

# when looking at the 3 different image chanels in the raster object, image 1 is red, 2 is green, and 3 is blue
values(cropped_img$V1_Breast_Cancer_Block_A_Section_1_image.1) <- vector(mode="integer", length=length(values(cropped_img$V1_Breast_Cancer_Block_A_Section_1_image.1))) 
values(cropped_img$V1_Breast_Cancer_Block_A_Section_1_image.2) <- vector(mode="integer", length=length(values(cropped_img$V1_Breast_Cancer_Block_A_Section_1_image.2))) 
values(cropped_img$V1_Breast_Cancer_Block_A_Section_1_image.3) <- vector(mode="integer", length=length(values(cropped_img$V1_Breast_Cancer_Block_A_Section_1_image.3))) 

#writeRaster(cropped_img, filename='data/testingRaster', format='GTiff', bandorder='BIL', overwrite=TRUE)


#checking the pixel distance between spots
differences <- c()
for (xIndex in seq(3, 127, by=2))
{
  for (yIndex in seq(3, 127, by=2))
  {
    differenceLeft <- image_location$pxl_row_in_fullres_xValue[image_location$array_row == xIndex & image_location$array_col == yIndex] - image_location$pxl_row_in_fullres_xValue[image_location$array_row == xIndex & image_location$array_col == yIndex - 2]
    differenceDown <- image_location$pxl_col_in_fullres_yValue[image_location$array_row == xIndex & image_location$array_col == yIndex] - image_location$pxl_col_in_fullres_yValue[image_location$array_row == xIndex - 1 & image_location$array_col == yIndex - 1]
    differences <- c(differences, differenceLeft)
    append(differences, differenceDown)
  }
}
mean(differences)
hist(differences)
```

